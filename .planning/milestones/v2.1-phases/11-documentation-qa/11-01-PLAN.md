---
phase: 11-documentation-qa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CLAUDE.md
  - src/tools_write.py
autonomous: true
requirements: [PIPE-01, PIPE-02, PIPE-03, PIPE-04, QA-01, QA-02, QA-03, QA-04]

must_haves:
  truths:
    - "CLAUDE.md pipeline shows 7 steps with STYLE REVIEW as step 6 between WRITE ANSWERS and VERIFY OUTPUT"
    - "CLAUDE.md documents SKIP convention in pipeline section, write_answers tool description, and agent guidance"
    - "CLAUDE.md agent guidance section shows simplified fast-path workflow (pair_id + answer_text only)"
    - "CLAUDE.md write_answers tool description shows answer_text fast-path answer format alongside legacy insertion_xml format"
    - "CLAUDE.md verify_output tool description mentions optional xpath and pair_id resolution"
    - "CLAUDE.md project structure lists pair_id_resolver.py and all v2.1 test files"
    - "write_answers docstring in tools_write.py mentions SKIP convention"
    - "All 311 tests pass after all documentation changes"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Updated pipeline, SKIP docs, fast-path guidance, project structure"
      contains: "STEP 6: STYLE REVIEW"
    - path: "src/tools_write.py"
      provides: "Updated write_answers docstring with SKIP mention"
      contains: "SKIP"
  key_links:
    - from: "CLAUDE.md pipeline section"
      to: "CLAUDE.md agent guidance section"
      via: "step numbering consistency"
      pattern: "STEP 7.*VERIFY OUTPUT"
    - from: "CLAUDE.md write_answers tool description"
      to: "src/tools_write.py docstring"
      via: "parameter documentation parity"
      pattern: "answer_text.*SKIP"
---

<objective>
Update CLAUDE.md to reflect the v2.1 simplified API (pair_id + answer_text fast path, SKIP convention, style review step), update tool docstrings, update project structure, and validate all test coverage.

Purpose: Phase 11 is the final phase of v2.1 Gemini Consolidation. All functional changes shipped in phases 8-10. This plan brings documentation and QA in line with the new API surface.

Output: Updated CLAUDE.md with 7-step pipeline, simplified agent guidance, SKIP documentation, and current project structure. Updated write_answers docstring. Full test suite validated.
</objective>

<execution_context>
@/home/sarturko/.claude/get-shit-done/workflows/execute-plan.md
@/home/sarturko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-documentation-qa/11-RESEARCH.md
@CLAUDE.md
@src/tools_write.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CLAUDE.md for v2.1 API surface</name>
  <files>CLAUDE.md</files>
  <action>
Read the full current CLAUDE.md (671 lines). Make the following targeted edits, preserving all existing accurate content:

**1. Pipeline section (lines ~44-99): Insert STYLE REVIEW step and renumber**

Change the pipeline from 6 steps to 7 steps:
- STEP 5: WRITE ANSWERS stays as-is, but update its Input line from "document bytes, array of {xpath, insertion_xml} pairs" to "document bytes, array of answer dicts (pair_id + answer_text, or legacy xpath + insertion_xml)" to reflect v2.1.
- Add new STEP 6: STYLE REVIEW (agent-side -- not an MCP tool). Content from research:
  ```
  STEP 6: STYLE REVIEW (agent-side -- not an MCP tool)
    Action: Agent opens or re-extracts the filled document and reviews
            formatting consistency. Check that inserted text matches the
            document's existing font, size, and style. This is a visual
            review step -- no MCP tool call needed.
    Note:   This step is recommended but optional. The server inherits
            formatting from target elements during write, so most answers
            will match. Review catches edge cases (e.g., bold headers
            that should not be bold in answers).
  ```
- Renumber old STEP 6 (VERIFY OUTPUT) to STEP 7. Update its Input line to: "filled document bytes, array of {pair_id, expected_text} dicts (xpath is optional -- resolved from pair_id if omitted)"

**2. Pipeline section: Add SKIP documentation to WRITE ANSWERS step**

After STEP 5's existing content, add a SKIP note:
```
  SKIP:   Set answer_text to "SKIP" (case-insensitive) for fields that
          should remain intentionally blank (signatures, dates, fields
          the user will fill manually). SKIP answers are not written to
          the document. The response summary reports written and skipped counts.
```

**3. Agent guidance section (lines ~111-141): Add simplified fast-path workflow**

BEFORE the existing "How the Calling Agent Orchestrates This" section, add a new subsection:

```
### Simplified Pipeline (v2.1 fast path)

For plain-text answers, agents need only `pair_id` and `answer_text` -- no xpath, no mode, no build_insertion_xml call. The server resolves everything automatically.

```
1. Agent calls extract_structure_compact(file_path="form.docx")
   -> gets compact_text with element IDs and role indicators
2. Agent identifies Q/A pairs from compact_text
   -> for each [answer] cell, note the pair_id (e.g., T1-R2-C2)
   -> generate the answer text from knowledge + user instructions
   -> use "SKIP" for fields the user will fill manually (signatures, dates)
3. Agent calls write_answers(file_path="form.docx", answers=[
       {"pair_id": "T1-R2-C2", "answer_text": "Acme Corp"},
       {"pair_id": "T1-R3-C2", "answer_text": "SKIP"},
   ], dry_run=True) -> preview
4. Agent calls write_answers(file_path="form.docx", answers=[...],
       output_file_path="filled.docx") -> filled document
5. Agent reviews style/formatting of filled document
6. Agent calls verify_output(file_path="filled.docx",
       expected_answers=[{"pair_id": "T1-R2-C2", "expected_text": "Acme Corp"}])
   -> confirms all answers written correctly
```

No validate_locations, no build_insertion_xml, no xpath bookkeeping needed.
The full pipeline (with validate_locations and build_insertion_xml) remains
available for structured OOXML answers or agents that need snippet matching.
```

Then rename the existing section to "### Full Pipeline (legacy path)" and update its step numbering:
- Step 10 (verify_output) becomes step 11 (after new style review step 10.5 or renumber as appropriate)
- Step 11 (report unknowns) becomes step 12

**4. write_answers tool description in CLAUDE.md (lines ~312-372): Add fast-path answer format**

After the existing Word answer JSON example (lines ~327-335), add a new "Fast-path answer (Word -- v2.1, recommended)" example:
```json
{
  "pair_id": "T1-R2-C2",
  "answer_text": "Acme Corporation"
}
```
With note: "When using `answer_text`, `xpath` and `mode` are optional -- the server resolves xpath from pair_id and defaults mode to `replace_content`."

After the modes section (lines ~367-370), add the SKIP convention documentation:
```
**SKIP convention:** Set `answer_text` to `"SKIP"` (case-insensitive) for fields
that should be left intentionally blank -- signatures, dates the signer fills in,
or fields the user wants to complete manually. SKIP answers are not written to
the document. The response summary reports the count of skipped fields.
```

Also add to the response description after "Returns the complete document as bytes...":
```
The response always includes a `summary` dict: `{"written": N, "skipped": M}`.
May include a `warnings` list when pair_id cross-check detects mismatches.
```

**5. verify_output tool description (lines ~374-419): Document pair_id-only path**

Update the "Each expected_answer is:" example to show pair_id-only:
```json
{
  "pair_id": "T1-R2-C2",
  "expected_text": "Acme Corporation",
  "confidence": "known"
}
```
Add note: "`xpath` is optional -- when omitted, the server resolves it from `pair_id` via re-extraction. When both are provided, the server cross-checks and warns on mismatch (pair_id takes precedence). Response includes `resolved_from` metadata on each content result."

**6. Project Structure (lines ~425-491): Add missing v2.1 files**

In the `src/` section, add after `tool_errors.py`:
```
│   ├── pair_id_resolver.py    # pair_id->xpath resolution via re-extraction
```

In the `tests/` section, add the missing test files:
```
│   ├── test_pair_id_resolver.py
│   ├── test_resolution.py
│   ├── test_ergonomics.py
```

**7. Search for all remaining "STEP 6" references and update to "STEP 7"**

Grep through the entire CLAUDE.md for any remaining references to step 6 as verify and ensure they say step 7. Also check for "step 10" in the full pipeline agent guidance that should now reference the style review.

IMPORTANT: Do NOT rewrite sections wholesale. Make surgical edits preserving existing accurate content. The research warns about over-writing existing v2.1 documentation (Pitfall 1) and renumbering chaos (Pitfall 2).
  </action>
  <verify>
Verify the following in the updated CLAUDE.md:
1. `grep -c "STEP 6: STYLE REVIEW" CLAUDE.md` returns 1
2. `grep -c "STEP 7: VERIFY OUTPUT" CLAUDE.md` returns 1
3. `grep -c "SKIP" CLAUDE.md` returns at least 5 (pipeline, tool desc, guidance, multiple mentions)
4. `grep -c "pair_id_resolver" CLAUDE.md` returns at least 1
5. `grep -c "Simplified Pipeline" CLAUDE.md` returns 1
6. `grep -c "answer_text" CLAUDE.md` returns at least 3 (tool desc, fast-path example, guidance)
7. No orphaned "STEP 6.*VERIFY" references remain
8. The pipeline section has exactly 7 numbered steps
  </verify>
  <done>
CLAUDE.md contains: 7-step pipeline with STYLE REVIEW as step 6, SKIP convention documented in 3 places (pipeline, tool desc, guidance), simplified fast-path agent guidance with pair_id + answer_text workflow, updated write_answers and verify_output tool descriptions showing v2.1 parameters, and project structure listing pair_id_resolver.py and all v2.1 test files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update docstring, validate test coverage, run full suite</name>
  <files>src/tools_write.py</files>
  <action>
**1. Update write_answers docstring in src/tools_write.py (line ~107-130)**

Add SKIP convention mention after the existing "dry_run:" paragraph. Insert:
```
    SKIP convention: Set answer_text to "SKIP" (case-insensitive) for fields
    that should remain blank. SKIP answers are excluded from writing. The
    response summary reports written and skipped counts.
```

This is a minor addition -- do NOT rewrite the existing docstring content. The docstring already correctly documents pair_id, answer_text, optional xpath/mode.

**2. Validate existing test coverage for QA-02/03/04**

Confirm these test files exist and contain the expected test classes:
- tests/test_resolution.py: TestPairIdOnlyWrite (QA-02), TestPairIdOnlyVerify (QA-04)
- tests/test_pair_id_resolver.py: resolver unit tests (QA-02)
- tests/test_ergonomics.py: TestSkipConvention (QA-03), TestWriteAnswersSummary (QA-03)

Run each test file individually to confirm they pass:
```
pytest tests/test_resolution.py -v
pytest tests/test_pair_id_resolver.py -v
pytest tests/test_ergonomics.py -v
```

**3. Run full test suite (QA-01)**

Run `pytest tests/ -q` and confirm:
- 311 tests pass (the 281 pre-v2.1 + 30 from phases 8-10)
- 0 failures
- 0 errors

The research identifies 3 LOW-priority edge case gaps (SKIP in verify expected_answers, multi-answer pair_id-only Word write, PDF pair_id-only verify). These are already covered by the existing test infrastructure and do not warrant new tests -- the core paths have 26 dedicated tests across 3 test files.
  </action>
  <verify>
1. `pytest tests/ -q` shows 311 passed, 0 failed
2. `pytest tests/test_resolution.py -v` shows TestPairIdOnlyWrite and TestPairIdOnlyVerify classes passing
3. `pytest tests/test_pair_id_resolver.py -v` shows all resolver tests passing
4. `pytest tests/test_ergonomics.py -v` shows TestSkipConvention and TestWriteAnswersSummary passing
5. `grep "SKIP" src/tools_write.py` shows SKIP convention in docstring
  </verify>
  <done>
write_answers docstring includes SKIP convention mention. All 311 tests pass. Test coverage for QA-02 (pair_id resolution: 15 tests), QA-03 (SKIP handling: 6 tests), and QA-04 (verify with pair_id: 5 tests) confirmed present and passing.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. CLAUDE.md pipeline has 7 steps (STYLE REVIEW is step 6, VERIFY OUTPUT is step 7)
2. CLAUDE.md documents SKIP in pipeline section, write_answers description, and agent guidance
3. CLAUDE.md has simplified fast-path agent guidance showing pair_id + answer_text workflow
4. CLAUDE.md write_answers and verify_output descriptions reflect v2.1 parameters
5. CLAUDE.md project structure includes pair_id_resolver.py and v2.1 test files
6. write_answers docstring in tools_write.py mentions SKIP convention
7. All 311 tests pass with 0 failures
8. Test coverage mapped to QA-02/03/04 requirements confirmed
</verification>

<success_criteria>
- CLAUDE.md accurately reflects the v2.1 API surface (pair_id + answer_text fast path)
- No agent reading CLAUDE.md would use the old workflow for plain-text answers
- SKIP convention is discoverable in 3 natural places (pipeline overview, tool reference, guidance)
- Step numbering is consistent throughout CLAUDE.md (no orphaned references)
- Project structure matches actual file tree
- All 311 tests pass -- zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/11-documentation-qa/11-01-SUMMARY.md`
</output>
