---
phase: 05-fast-path-foundation
plan: 02
type: execute
wave: 2
depends_on:
  - "05-01"
files_modified:
  - src/tool_errors.py
  - tests/test_e2e_integration.py
autonomous: true
requirements:
  - FAST-04
  - COMPAT-01
  - COMPAT-02

must_haves:
  truths:
    - "Validation rejects answers with neither answer_text nor insertion_xml, naming both fields in the error"
    - "Validation rejects answers with BOTH answer_text and insertion_xml, telling the agent to use one"
    - "All invalid answers in a batch are listed in the error, not just the first"
    - "A mixed-mode write_answers call (some answer_text, some insertion_xml) passes validation"
    - "Existing agents sending insertion_xml-only answers continue working without changes"
    - "Empty string and whitespace-only strings are treated as 'not provided'"
    - "The entire batch is rejected if ANY answer is invalid (no partial writes)"
    - "Excel/PDF relaxed path accepts answer_text as an alias for value/insertion_xml"
  artifacts:
    - path: "src/tool_errors.py"
      provides: "Batch validation with exactly-one-of semantics and error aggregation"
      contains: "_is_provided"
    - path: "tests/test_e2e_integration.py"
      provides: "Integration tests for new validation behavior"
      contains: "test_write_answers_rejects_both_fields"
  key_links:
    - from: "src/tool_errors.py"
      to: "src/tools_write.py"
      via: "build_answer_payloads called by write_answers tool"
      pattern: "build_answer_payloads"
    - from: "src/tool_errors.py"
      to: "src/models.py"
      via: "constructs AnswerPayload with new optional fields"
      pattern: "AnswerPayload"
---

<objective>
Implement batch validation in tool_errors.py that enforces exactly-one-of semantics for answer_text/insertion_xml, with agent-friendly error messages listing all invalid answers.

Purpose: Enforce the API contract so agents get clear, actionable errors when they misuse the fields. All-or-nothing batch rejection prevents partial document corruption.
Output: Updated validation in tool_errors.py, comprehensive integration tests proving all validation paths.
</objective>

<execution_context>
@/home/sarturko/.claude/get-shit-done/workflows/execute-plan.md
@/home/sarturko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-fast-path-foundation/05-CONTEXT.md
@.planning/phases/05-fast-path-foundation/05-RESEARCH.md
@.planning/phases/05-fast-path-foundation/05-01-SUMMARY.md
@src/tool_errors.py
@src/tools_write.py
@src/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement batch validation logic in tool_errors.py</name>
  <files>
    src/tool_errors.py
  </files>
  <action>
**Add helper function:**
Add `_is_provided(value: str | None) -> bool` near the top of tool_errors.py (after the USAGE dict). Returns `True` only if value is not None AND value.strip() is not empty. This is the single source of truth for "is this field provided?" per the user decision.

**Add batch validation function:**
Add `_validate_answer_text_xml_fields(answer_dicts: list[dict]) -> None` that:
1. Iterates all answer dicts, collecting errors (not short-circuiting)
2. For each answer, gets `pair_id` via `.get("pair_id", "<missing>")` (Pitfall 4 from research)
3. Checks `_is_provided(a.get("answer_text"))` and `_is_provided(a.get("insertion_xml"))` (also check `a.get("value")` for relaxed path compat)
4. If BOTH provided: append error `"Answer '{pair_id}' (index {i}): Both \`answer_text\` and \`insertion_xml\` provided -- use one, not both. Use \`answer_text\` for plain text, \`insertion_xml\` for structured OOXML."`
5. If NEITHER provided: append error `"Answer '{pair_id}' (index {i}): Neither \`answer_text\` nor \`insertion_xml\` provided. Use \`answer_text\` for plain text answers, \`insertion_xml\` for structured OOXML."`
6. After iterating ALL answers, if errors exist: raise ValueError with header `"write_answers validation failed ({len(errors)} invalid answer(s)):\n"` followed by newline-joined errors

**Update _WORD_REQUIRED and _ALL_KNOWN_FIELDS:**
- Change `_WORD_REQUIRED` from `("pair_id", "xpath", "insertion_xml", "mode")` to `("pair_id", "xpath", "mode")` -- insertion_xml is no longer unconditionally required
- Add `"answer_text"` to `_ALL_KNOWN_FIELDS`: `_ALL_KNOWN_FIELDS = {*_WORD_REQUIRED, *_WORD_OPTIONAL, "answer_text", "insertion_xml"}`
- Keep `_WORD_OPTIONAL = ("confidence",)` as is

**Update _build_word_payloads:**
1. After the missing-required-fields check, call `_validate_answer_text_xml_fields(answer_dicts)` to run the exactly-one-of check across ALL answers before processing any. This enforces batch rejection.
2. Update the AnswerPayload construction: instead of always reading `a["insertion_xml"]`, use `a.get("insertion_xml")` (may be None). Add `answer_text=a.get("answer_text")`.
3. Remove the old `insertion_xml` from the missing-fields check (it is now validated by the batch validator, not the per-field required check).

**Update _build_relaxed_payloads (Excel/PDF):**
1. Call `_validate_answer_text_xml_fields(answer_dicts)` at the start of the function, before the per-answer loop. This ensures Excel/PDF also reject invalid field combinations.
2. Update the insertion_xml assignment: `a.get("insertion_xml") or a.get("value") or a.get("answer_text", "")`. This means `answer_text` works as an alias for the value in Excel/PDF context.
3. Also pass `answer_text=a.get("answer_text")` to the AnswerPayload constructor.

**Update USAGE dict:**
Update the `write_answers` example to show answer_text as an option: `'write_answers(file_path="form.docx", answers=[{"pair_id": "q1", "xpath": "/w:body/...", "answer_text": "Acme Corp", "mode": "replace_content"}])'`
  </action>
  <verify>
Run `python -m pytest tests/ -x -q` -- all 234 existing tests must still pass. This confirms COMPAT-01 (existing insertion_xml callers unbroken).
  </verify>
  <done>
Validation logic implemented: _is_provided helper, batch validation with error aggregation, updated _WORD_REQUIRED, updated both Word and relaxed payload builders, USAGE example updated. All 234 existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add integration tests for answer_text/insertion_xml validation</name>
  <files>
    tests/test_e2e_integration.py
  </files>
  <action>
Add a new test class `TestAnswerTextValidation` to tests/test_e2e_integration.py. Import `build_answer_payloads` from `src.tool_errors` and `FileType` from `src.models`.

**Test cases (all use `build_answer_payloads` directly, not MCP tool calls):**

1. `test_insertion_xml_only_still_works` -- Pass a dict with `insertion_xml` (no `answer_text`). Confirm it creates an AnswerPayload with `insertion_xml` set and `answer_text` as None. (COMPAT-01)

2. `test_answer_text_only_works` -- Pass a dict with `answer_text` (no `insertion_xml`). Confirm it creates an AnswerPayload with `answer_text` set and `insertion_xml` as None. (New fast path)

3. `test_rejects_both_fields_provided` -- Pass a dict with BOTH `answer_text="hello"` and `insertion_xml="<w:r/>..."`. Assert ValueError is raised with "Both `answer_text` and `insertion_xml` provided" in the message. (FAST-04)

4. `test_rejects_neither_field_provided` -- Pass a dict with neither field. Assert ValueError with "Neither `answer_text` nor `insertion_xml` provided" in the message. (FAST-04)

5. `test_empty_string_treated_as_not_provided` -- Pass `answer_text=""` and `insertion_xml=""`. Assert ValueError with "Neither" message (empty strings are not provided). (User decision: strip-check)

6. `test_whitespace_only_treated_as_not_provided` -- Pass `answer_text="   "` and `insertion_xml=""`. Assert ValueError with "Neither" message. (User decision: whitespace = not provided)

7. `test_mixed_mode_batch_accepted` -- Pass a batch of 3 answers: first uses `insertion_xml`, second uses `answer_text`, third uses `insertion_xml`. Confirm all 3 are created successfully as AnswerPayloads. (COMPAT-02)

8. `test_batch_rejects_all_if_any_invalid` -- Pass a batch of 3 answers: first is valid (insertion_xml), second has neither field, third has both fields. Assert ValueError is raised listing BOTH invalid answers (index 1 and index 2). Confirm the error message contains both "index 1" and "index 2". (Batch rejection)

9. `test_error_lists_all_invalid_not_just_first` -- Same as above but verify the error count in the header: "2 invalid answer(s)". (All-errors-listed)

10. `test_error_includes_pair_id_and_index` -- Pass an invalid answer with pair_id="q3". Assert the error contains "Answer 'q3' (index 0)". (Error format)

11. `test_relaxed_path_accepts_answer_text` -- Call `build_answer_payloads` with `ft=FileType.EXCEL` and a dict using `answer_text`. Confirm it works. (COMPAT-02 for Excel/PDF)

12. `test_relaxed_path_rejects_both_fields` -- Call with `ft=FileType.EXCEL` and both `answer_text` and `insertion_xml` set. Assert ValueError. (Consistent validation across paths)

For Word tests, use `ft=FileType.WORD`. For relaxed path tests, use `ft=FileType.EXCEL`. Each dict needs at minimum `pair_id`, `xpath`, `mode`, plus the content field(s) being tested.
  </action>
  <verify>
Run `python -m pytest tests/test_e2e_integration.py::TestAnswerTextValidation -x -v` -- all 12 new tests pass. Then run `python -m pytest tests/ -x -q` -- full suite passes (234 original + parity tests from Plan 01 + these 12).
  </verify>
  <done>
12 integration tests cover all validation paths: insertion_xml-only (COMPAT-01), answer_text-only (new), both-rejected (FAST-04), neither-rejected (FAST-04), empty/whitespace handling, mixed-mode batch (COMPAT-02), batch rejection, error format, and relaxed path (Excel/PDF). Full test suite passes.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` -- entire suite passes (all original + all new tests)
2. Confirm FAST-04: tests prove neither-provided and both-provided are rejected with correct error messages
3. Confirm COMPAT-01: tests prove insertion_xml-only callers work unchanged; all 234 original tests pass
4. Confirm COMPAT-02: tests prove a mixed batch (some answer_text, some insertion_xml) is accepted
5. Confirm error messages match exact wording from CONTEXT.md user decisions
6. Confirm batch rejection: one invalid answer in a batch of 3 causes all to be rejected
</verification>

<success_criteria>
- _is_provided helper correctly handles None, empty string, and whitespace-only
- Batch validation collects ALL errors before raising (not short-circuit)
- Error messages include pair_id and index for each invalid answer
- Distinct messages for "both provided" and "neither provided" cases
- Mixed-mode batches pass validation (some answer_text, some insertion_xml)
- Existing insertion_xml-only callers work without changes
- Excel/PDF relaxed path accepts answer_text as an alias
- All original 234 tests + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-fast-path-foundation/05-02-SUMMARY.md`
</output>
