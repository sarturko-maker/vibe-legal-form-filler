---
phase: 04-cross-platform-verification
plan: 02
type: execute
wave: 2
depends_on:
  - "04-01"
files_modified: []
autonomous: false
requirements:
  - XPLAT-01
  - XPLAT-02
  - XPLAT-03
  - XPLAT-04

must_haves:
  truths:
    - "Gemini CLI connects to the HTTP server and discovers all 7 MCP tools"
    - "Gemini CLI completes the full questionnaire pipeline (extract -> validate -> build -> write -> verify)"
    - "Antigravity connects to the HTTP server and discovers all MCP tools"
    - "Antigravity completes the full questionnaire pipeline (extract -> validate -> build -> write -> verify)"
  artifacts: []
  key_links:
    - from: "~/.gemini/settings.json"
      to: "http://127.0.0.1:8000/mcp"
      via: "httpUrl config key"
      pattern: "httpUrl"
    - from: "~/.gemini/antigravity/mcp_config.json"
      to: "http://127.0.0.1:8000/mcp"
      via: "serverUrl config key"
      pattern: "serverUrl"
---

<objective>
Verify that Gemini CLI and Antigravity can connect to the HTTP server, discover all tools, and complete the full form-filling pipeline. This is a manual verification phase — Claude configures the platforms, the human runs interactive tests.

Purpose: Prove the HTTP transport works with real cross-platform MCP clients, not just synthetic tests.
Output: Verified tool discovery and pipeline completion on both platforms.
</objective>

<execution_context>
@/home/sarturko/.claude/get-shit-done/workflows/execute-plan.md
@/home/sarturko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cross-platform-verification/04-RESEARCH.md
@.planning/phases/04-cross-platform-verification/04-01-SUMMARY.md
@src/server.py
@docs/gemini-cli-setup.md
@docs/antigravity-setup.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Gemini CLI and Antigravity for HTTP transport</name>
  <files></files>
  <action>
Read the current Gemini CLI config at `~/.gemini/settings.json`. Add a `form-filler-http` entry under `mcpServers` with:
```json
"form-filler-http": {
  "httpUrl": "http://127.0.0.1:8000/mcp",
  "trust": true
}
```
Preserve the existing `form-filler` stdio entry. Use `httpUrl` (NOT `url`).

Read the current Antigravity config at `~/.gemini/antigravity/mcp_config.json`. Add a `form-filler-http` entry under `mcpServers` with:
```json
"form-filler-http": {
  "serverUrl": "http://127.0.0.1:8000/mcp"
}
```
Use `serverUrl` (NOT `httpUrl`).

Start the HTTP server in the background to prepare for verification:
```bash
cd /home/sarturko/vibe-legal-form-filler
python -m src.server --transport http &
```
Confirm it binds to 127.0.0.1:8000 by checking the uvicorn output.

Also confirm the existing stdio config still works by running:
```bash
cd /home/sarturko/vibe-legal-form-filler
python -m src.server --help
```
This validates the CLI parsing still accepts both transport modes.
  </action>
  <verify>
Gemini CLI config has `form-filler-http` with `httpUrl`:
```bash
grep -q "httpUrl" ~/.gemini/settings.json && echo "Gemini OK"
```
Antigravity config has `form-filler-http` with `serverUrl`:
```bash
grep -q "serverUrl" ~/.gemini/antigravity/mcp_config.json && echo "Antigravity OK"
```
HTTP server starts without errors:
```bash
python -m src.server --transport http &
sleep 2
curl -s http://127.0.0.1:8000/mcp -o /dev/null -w "%{http_code}"
kill %1
```
  </verify>
  <done>Both platform configs have HTTP MCP server entries. HTTP server starts and accepts connections on 127.0.0.1:8000/mcp. Existing stdio config is preserved.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Gemini CLI and Antigravity tool discovery and pipeline</name>
  <files></files>
  <action>
Human verifies that both platforms connect to the HTTP server and complete the pipeline.

What was built: Configured Gemini CLI and Antigravity to connect to the HTTP MCP server at http://127.0.0.1:8000/mcp. The HTTP server is ready to start.

PART A — Gemini CLI Verification (XPLAT-01 + XPLAT-02):

1. Start the HTTP server in Terminal 1:
   cd /home/sarturko/vibe-legal-form-filler && python -m src.server --transport http
   Expected: "Uvicorn running on http://127.0.0.1:8000"

2. In Terminal 2, disable the stdio form-filler to avoid tool name conflicts:
   gemini mcp disable form-filler

3. Start Gemini CLI and check tool discovery:
   gemini
   Then type: /mcp
   Expected: form-filler-http shows CONNECTED with 7 tools listed (extract_structure_compact, extract_structure, validate_locations, build_insertion_xml, write_answers, verify_output, list_form_fields).

4. Run the full pipeline by pasting this prompt into Gemini CLI:
   "Using the form-filler MCP tools, fill out the questionnaire at tests/fixtures/table_questionnaire.docx:
   1. Call extract_structure_compact with file_path="tests/fixtures/table_questionnaire.docx"
   2. From the compact_text, identify 2-3 answer targets
   3. Call validate_locations for those element IDs
   4. Call build_insertion_xml for each answer with plain text
   5. Call write_answers with output_file_path="/tmp/filled_questionnaire.docx"
   6. Call verify_output on the filled document
   Show me the results at each step."
   Expected: Each tool call succeeds, verify_output shows matched answers.

5. Re-enable stdio form-filler: gemini mcp enable form-filler

PART B — Antigravity Verification (XPLAT-03 + XPLAT-04):

1. Ensure the HTTP server is still running from Part A.
2. Open Antigravity and navigate to the project directory.
3. Check tool discovery: Click "..." menu in Agent panel, select "MCP Servers".
   Expected: form-filler-http appears with tools listed.
4. Run the same pipeline prompt. If stalls on tool calls (known issue FastMCP #2489), note as known limitation.
5. Stop the HTTP server (Ctrl+C).

Report: For each platform, did tool discovery show all 7 tools? Did the pipeline complete? Any errors?
  </action>
  <verify>
Human confirms:
- Gemini CLI /mcp shows form-filler-http CONNECTED with 7 tools
- Gemini CLI pipeline runs extract -> validate -> build -> write -> verify successfully
- Antigravity MCP Servers panel shows form-filler-http with tools
- Antigravity pipeline completes (or stalling limitation documented)
  </verify>
  <done>Both platforms verified: Gemini CLI discovers all 7 tools and completes pipeline. Antigravity discovers tools and completes pipeline (or limitation documented). Resume signal: type "approved" or describe issues.</done>
</task>

</tasks>

<verification>
Both platforms configured and tested:
1. Gemini CLI: tool discovery shows 7 tools, pipeline completes
2. Antigravity: tool discovery shows tools, pipeline completes (or limitation documented)
3. Existing stdio config preserved and still works
</verification>

<success_criteria>
Gemini CLI successfully discovers all 7 MCP tools via HTTP and completes the full questionnaire pipeline. Antigravity successfully connects and discovers tools via HTTP (pipeline completion is best-effort due to known stalling issue). Both platform configs are saved and the existing stdio config is unchanged.
</success_criteria>

<output>
After completion, create `.planning/phases/04-cross-platform-verification/04-02-SUMMARY.md`
</output>
